<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>IPTV Player - Controle Remoto Corrigido</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<style>
  body, html {
    margin:0; padding:0; background:#000; color:#fff; font-family:sans-serif; height:100vh; overflow:hidden;
  }
  #senhaSection {
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background:#000;
    display:flex; flex-direction:column; justify-content:center; align-items:center; gap:10px;
    z-index: 1000;
  }
  #senhaInput {
    padding:8px; font-size:16px; width:220px; border-radius:5px; border:none; text-align:center; background:#222; color:#fff;
  }
  #senhaBtn {
    padding:10px 20px; font-size:16px; cursor:pointer; background:#1c1c1c; border:1px solid #444; color:#fff; border-radius:5px;
  }
  small { color:#888; }

  .container {
    height:100vh; width:100vw; display:flex; background:#000;
  }
  .sidebar {
    background:#111; width:320px; padding:10px; box-sizing:border-box; display:flex; flex-direction:column;
  }
  .top-buttons {
    display:flex; gap:10px; margin-bottom:10px;
  }
  .top-buttons button {
    flex:1; padding:8px; font-size:14px; cursor:pointer; border-radius:4px; background:#222; border:1px solid #444; color:#fff;
  }
  .top-buttons button:hover, .top-buttons button:focus {
    background:#333;
    outline:none;
  }
  #vipMenu {
    display:none; flex-direction:column; gap:5px; margin-bottom:10px;
  }
  #vipMenu button {
    background:#222; border:1px solid #444; padding:6px; border-radius:3px; cursor:pointer; color:#fff;
  }
  #vipMenu button:hover, #vipMenu button:focus { background:#333; outline:none; }
  h2 {
    margin:0 0 10px 0;
  }
  .search-container {
    display:flex; align-items:center; background:#222; padding:5px; border-radius:5px; margin-bottom:10px;
  }
  .search-container input {
    flex:1; background:transparent; border:none; color:#fff; font-size:14px; padding:5px;
  }
  .search-container input::placeholder {
    color:#888;
  }
  #channelList {
    overflow-y:auto; flex:1; outline:none;
  }
  .channel {
    display:flex; align-items:center; padding:8px; cursor:pointer; border-bottom:1px solid #222;
  }
  .channel:hover, .channel:focus {
    background:#222;
    outline:none;
  }
  .channel:focus {
    background:#444;
    outline: 2px solid #fff;
  }
  .channel img {
    width:50px; height:50px; object-fit:contain; margin-right:10px;
  }
  .channel-name {
    flex:1; font-size:16px;
  }
  .favorite-btn {
    margin-left:auto; font-size:20px; background:none; border:none; cursor:pointer; color:gold;
  }
  .favorite-btn.not-fav {
    color:#555;
  }
  .main {
    flex:1; position:relative; display:flex; flex-direction:column; background:#000;
  }
  #videoContainer {
    position:relative; background:black; width:100%; height:100vh; display:none;
  }
  #videoContainer.active {
    display:block;
  }
  video {
    width:100%; height:100vh; object-fit:contain; background:black;
  }
  .player-controls {
    position:absolute; top:10px; left:50%; transform:translateX(-50%);
    display:flex; gap:10px; z-index:10; background:rgba(0,0,0,0.5); padding:10px; border-radius:5px;
  }
  .player-controls button {
    padding:6px 12px; font-size:14px; background:#333; color:#fff; border:none; border-radius:4px; cursor:pointer;
  }
  .hidden {
    display:none !important;
  }
</style>
</head>
<body>

<!-- TELA DE SENHA, s√≥ aparece inicialmente -->
<div id="senhaSection" role="dialog" aria-modal="true" aria-label="Tela de senha">
  <input id="senhaInput" type="password" placeholder="Digite a senha do cliente" autocomplete="off" aria-label="Campo de senha"/>
  <button id="senhaBtn" aria-label="Bot√£o entrar">Entrar</button>
  <small>Bem Vindo</small>
</div>

<!-- CONTAINER PRINCIPAL, inicialmente escondido -->
<div class="container hidden" role="main" aria-hidden="true" tabindex="0">
  <div class="sidebar" role="navigation" aria-label="Lista de canais e menus">
    <div class="top-buttons">
      <button id="usarBtn" aria-label="Lista Player">Lista Player</button>
      <button id="vipBtn" aria-label="Lista VIP">Lista Vip</button>
    </div>
    <div id="vipMenu" aria-label="Menu VIP"></div>
    <h2>Canais</h2>
    <div class="search-container">
      üîç<input id="searchInput" type="text" placeholder="Pesquisar canal..." autocomplete="off" aria-label="Pesquisar canal"/>
    </div>
    <div id="channelList" tabindex="0" aria-label="Lista de canais"></div>
  </div>
  <div class="main">
    <div id="videoContainer" aria-live="polite">
      <video id="video" controls autoplay></video>
      <div class="player-controls">
        <button id="prevBtn" aria-label="Voltar canal">‚èÆÔ∏è Voltar</button>
        <button id="nextBtn" aria-label="Pr√≥ximo canal">‚è≠Ô∏è Pr√≥ximo</button>
        <button id="exitBtn" aria-label="Voltar ao menu">Menu üì∫</button>
      </div>
    </div>
  </div>
</div>

<script>
  console.clear();
  console.log("IPTV Player iniciado");

  const validPwd = ['8888','9999'];
  const listUrl = 'https://iptv.vivatele.com//get.php?username=viva_padrao&password=viva2384&type=m3u_plus&output=m3u8'; // Link teste, substitua pelo seu real

  let allChannels = [];
  let currentIndex = 0;
  let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');

  const senhaSection = document.getElementById('senhaSection');
  const senhaInput = document.getElementById('senhaInput');
  const senhaBtn = document.getElementById('senhaBtn');
  const container = document.querySelector('.container');

  const usarBtn = document.getElementById('usarBtn');
  const vipBtn = document.getElementById('vipBtn');
  const vipMenu = document.getElementById('vipMenu');

  const searchInput = document.getElementById('searchInput');
  const channelList = document.getElementById('channelList');

  const videoContainer = document.getElementById('videoContainer');
  const video = document.getElementById('video');

  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const exitBtn = document.getElementById('exitBtn');

  // Fun√ß√£o simples para parsear M3U
  function parseM3U(data) {
    const lines = data.split('\n');
    const channels = [];
    let channel = null;
    for(let i=0; i<lines.length; i++) {
      let line = lines[i].trim();
      if(line.startsWith('#EXTINF:')) {
        const tvg_name = (line.match(/tvg-name="([^"]+)"/) || [null, 'Canal'])[1];
        const tvg_logo = (line.match(/tvg-logo="([^"]+)"/) || [null, ''])[1];
        const group_title = (line.match(/group-title="([^"]+)"/) || [null, ''])[1];
        channel = {tvg_name, tvg_logo, group_title, url:''};
      } else if(line && channel) {
        channel.url = line;
        channels.push(channel);
        channel = null;
      }
    }
    console.log(`Canais carregados: ${channels.length}`);
    return channels;
  }

  async function loadChannels(url) {
    try {
      const res = await fetch(url);
      if(!res.ok) throw new Error('Falha ao carregar lista');
      const text = await res.text();
      return parseM3U(text);
    } catch(e) {
      console.error('Erro ao carregar canais:', e);
      alert('Erro ao carregar canais');
      return [];
    }
  }

  // Renderiza lista de canais e adiciona foco + navega√ß√£o por teclado
  function renderChannelList(channels) {
    channelList.innerHTML = '';
    if(channels.length === 0) {
      channelList.innerHTML = '<p>Nenhum canal encontrado.</p>';
      return;
    }
    channels.forEach((channel, index) => {
      const div = document.createElement('div');
      div.className = 'channel';
      div.tabIndex = 0;
      div.setAttribute('role','button');
      div.setAttribute('aria-label', `Canal ${channel.tvg_name}`);
      div.dataset.index = index;

      const img = document.createElement('img');
      img.src = channel.tvg_logo || 'https://via.placeholder.com/50?text=No+Logo';
      img.alt = channel.tvg_name;
      div.appendChild(img);

      const span = document.createElement('span');
      span.className = 'channel-name';
      span.textContent = channel.tvg_name;
      div.appendChild(span);

      div.addEventListener('click', () => {
        playChannel(channel);
        currentIndex = index;
      });

      div.addEventListener('keydown', e => {
        if(e.key === 'Enter' || e.key === ' ') {
          playChannel(channel);
          currentIndex = index;
          e.preventDefault();
        }
        else if(e.key === 'ArrowDown') {
          if(div.nextElementSibling) div.nextElementSibling.focus();
          e.preventDefault();
        }
        else if(e.key === 'ArrowUp') {
          if(div.previousElementSibling) div.previousElementSibling.focus();
          else channelList.focus();
          e.preventDefault();
        }
        else if(e.key === 'ArrowRight') {
          // Sair para player se canal j√° estiver tocando e expandir video
          if(videoContainer.classList.contains('active')) {
            toggleFullscreen();
          }
          e.preventDefault();
        }
        else if(e.key === 'ArrowLeft') {
          // Voltar foco para lista se estiver no player
          if(videoContainer.classList.contains('active')) {
            exitPlayer();
          }
          e.preventDefault();
        }
      });

      channelList.appendChild(div);
    });
  }

  // Play canal com HLS
  function playChannel(channel) {
    if(!channel || !channel.url) return;
    console.log('Tocando canal:', channel.tvg_name, channel.url);
    videoContainer.classList.add('active');
    video.src = '';
    if(window.hls) {
      window.hls.destroy();
      window.hls = null;
    }

    if(Hls.isSupported()) {
      window.hls = new Hls();
      window.hls.loadSource(channel.url);
      window.hls.attachMedia(video);
      window.hls.on(Hls.Events.ERROR, function(event, data) {
        console.error('Erro HLS:', data);
      });
    } else if(video.canPlayType('application/vnd.apple.mpegurl')) {
      video.src = channel.url;
    } else {
      alert('Seu navegador n√£o suporta reprodu√ß√£o deste formato.');
    }
    video.play();
  }

  function nextChannel() {
    currentIndex = (currentIndex + 1) % allChannels.length;
    playChannel(allChannels[currentIndex]);
    focusChannel(currentIndex);
  }
  function prevChannel() {
    currentIndex = (currentIndex - 1 + allChannels.length) % allChannels.length;
    playChannel(allChannels[currentIndex]);
    focusChannel(currentIndex);
  }

  function exitPlayer() {
    video.pause();
    video.src = '';
    videoContainer.classList.remove('active');
    container.focus();
  }

  function toggleFullscreen() {
    if(!document.fullscreenElement) {
      videoContainer.requestFullscreen().catch(err => {
        console.error(`Erro ao ativar fullscreen: ${err.message}`);
      });
    } else {
      document.exitFullscreen();
    }
  }

  function focusChannel(index) {
    const items = channelList.querySelectorAll('.channel');
    if(items[index]) items[index].focus();
  }

  function filterChannels() {
    const q = searchInput.value.toLowerCase();
    if(q === '') {
      renderChannelList(allChannels);
      return;
    }
    const filtered = allChannels.filter(c => c.tvg_name.toLowerCase().includes(q));
    renderChannelList(filtered);
  }

  // Eventos bot√£o senha
  senhaBtn.onclick = () => {
    const val = senhaInput.value.trim();
    if(validPwd.includes(val)) {
      senhaSection.style.display = 'none';
      container.classList.remove('hidden');
      container.setAttribute('aria-hidden', 'false');
      senhaInput.value = '';
      loadChannels(listUrl).then(channels => {
        allChannels = channels;
        renderChannelList(allChannels);
        // foco no primeiro canal ap√≥s carregar lista
        setTimeout(() => focusChannel(0), 100);
      });
    } else {
      alert('Senha inv√°lida!');
      senhaInput.value = '';
      senhaInput.focus();
    }
  };

  senhaInput.addEventListener('keydown', e => {
    if(e.key === 'Enter') senhaBtn.click();
  });

  // Bot√µes top
  usarBtn.onclick = () => {
    loadChannels(listUrl).then(channels => {
      allChannels = channels;
      renderChannelList(allChannels);
      vipMenu.style.display = 'none';
      focusChannel(0);
    });
  };

  vipBtn.onclick = () => {
    vipMenu.innerHTML = '';
    // Exemplo: colocar urls VIP, adicione as suas aqui:
    const vipUrls = {
      VIP1: 'https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8',
      VIP2: 'https://bitdash-a.akamaihd.net/content/sintel/hls/playlist.m3u8'
    };
    for(const [key, url] of Object.entries(vipUrls)) {
      const b = document.createElement('button');
      b.textContent = `VIP ${key}`;
      b.tabIndex = 0;
      b.addEventListener('click', () => {
        loadChannels(url).then(channels => {
          allChannels = channels;
          renderChannelList(allChannels);
          vipMenu.style.display = 'flex';
          focusChannel(0);
        });
      });
      vipMenu.appendChild(b);
    }
    vipMenu.style.display = 'flex';
  };

  searchInput.addEventListener('input', filterChannels);

  prevBtn.onclick = () => {
    prevChannel();
  };

  nextBtn.onclick = () => {
    nextChannel();
  };

  exitBtn.onclick = () => {
    exitPlayer();
  };

  // Navega√ß√£o teclado na lista de canais
  channelList.addEventListener('keydown', e => {
    if(e.target.classList.contains('channel')) {
      if(e.key === 'ArrowDown') {
        if(e.target.nextElementSibling) {
          e.target.nextElementSibling.focus();
          e.preventDefault();
        }
      }
      else if(e.key === 'ArrowUp') {
        if(e.target.previousElementSibling) {
          e.target.previousElementSibling.focus();
          e.preventDefault();
        }
      }
    }
  });

  // Foco inicial na senha
  window.onload = () => {
    senhaInput.focus();
  };
</script>

</body>
</html>
